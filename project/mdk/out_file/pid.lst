C251 COMPILER V5.60.0,  pid                                                                23/11/25  21:54:34  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE pid
OBJECT MODULE PLACED IN .\out_file\pid.obj
COMPILER INVOKED BY: D:\keil_5\C251\BIN\C251.EXE ..\user\pid.c LARGE NOALIAS FLOAT64 WARNINGLEVEL(3) OPTIMIZE(0,SIZE) BR
                    -OWSE INCDIR(..\..\libraries\zf_common;..\..\libraries\zf_components;..\..\libraries\zf_device;..\..\libraries\zf_driver;
                    -..\user;..\code) DEBUG PRINT(.\out_file\pid.lst) OBJECT(.\out_file\pid.obj) 

stmt  level    source

    1          #include "pid.h"
    2          PID_Controllers PID; // 聚合控制器：左右速度环 + 转向环
    3          LowPassFilter_t encoder_l;
    4          LowPassFilter_t encoder_r;
    5          float delta_output = 0, speed_l = 0, speed_r = 0, max_integral = 0;
    6          // 速度环初始化（增量式），命名简洁
    7          void pid_speed_init(PID_Speed *pid, float kp, float ki, float kd, float max_out, float min_out)
    8          {
    9   1          pid->Kp = kp;
   10   1          pid->Ki = ki;
   11   1          pid->Kd = kd;
   12   1          pid->error = 0.0f;
   13   1          pid->prev_error = 0.0f;
   14   1          pid->prev2_error = 0.0f;
   15   1          pid->output = 0.0f;
   16   1          pid->max_output = max_out;
   17   1          pid->min_output = min_out;
   18   1      }
   19          // 转向环初始化（位置式），命名简洁
   20          void pid_steer_init(PID_Steer *pid, float kp, float kd, float kd_gyro, float max_out, float min_out)
   21          {
   22   1          pid->Kp = kp;
   23   1          pid->Kd = kd;
   24   1          pid->kd_gyro = kd_gyro;
   25   1          pid->error = 0.0f;
   26   1          pid->prev_error = 0.0f;
   27   1          pid->output = 0.0f;
   28   1          pid->max_output = max_out;
   29   1          pid->min_output = min_out;
   30   1      }
   31          // 编码器读取
   32          void Encoder_get(PID_Speed *pid_l, PID_Speed *pid_r)
   33          {
   34   1          // 读取编码器计数值并转换为速度（乘以系数0.2调整单位）
   35   1          pid_l->speed = encoder_get_count(TIM4_ENCOEDER) * 0.2f;  // 左轮速度
   36   1          pid_r->speed = -encoder_get_count(TIM3_ENCOEDER) * 0.2f; // 右轮速度（负号用于方向调整）
   37   1          low_pass_filter_mt(&encoder_l, &pid_l->speed, 0.8);
   38   1          low_pass_filter_mt(&encoder_r, &pid_r->speed, 0.8);
   39   1          // 清除编码器计数，准备下一次计数
   40   1          encoder_clear_count(TIM3_ENCOEDER);
   41   1          encoder_clear_count(TIM4_ENCOEDER);
   42   1      }
   43          // 速度环更新（增量式）
   44          void pid_speed_update(PID_Speed *pid, float target, float actual)
   45          {
   46   1          // 计算当前误差（直接使用结构体成员）
   47   1          pid->error = target - actual;
   48   1      
   49   1          // 增量式 PID_Direction：使用结构体成员计算差分与输出增量
   50   1          delta_output = pid->Kp * (pid->error - pid->prev_error) + pid->Ki * pid->error + pid->Kd * (pid->erro
             -r - 2.0f * pid->prev_error + pid->prev2_error);
   51   1      
   52   1          // 更新输出并限幅
   53   1          pid->output += delta_output;
   54   1          if (pid->output > pid->max_output)
   55   1          {
   56   2              pid->output = pid->max_output;
C251 COMPILER V5.60.0,  pid                                                                23/11/25  21:54:34  PAGE 2   

   57   2          }
   58   1          else if (pid->output < -pid->max_output)
   59   1          {
   60   2              pid->output = -pid->max_output;
   61   2          }
   62   1      
   63   1          // 更新误差历史
   64   1          pid->prev2_error = pid->prev_error;
   65   1          pid->prev_error = pid->error;
   66   1      }
   67          
   68          // 转向环更新（位置式）
   69          void pid_steer_update(PID_Steer *pid, float error, float gyro)
   70          {
   71   1          // 计算当前误差（直接写入结构体成员）
   72   1          pid->error = error;
   73   1      
   74   1          // 位置式 PID_Direction：kd_gyro 以陀螺输入项参与
   75   1          pid->output = pid->Kp * pid->error + pid->kd_gyro * gyro + pid->Kd * (pid->error - pid->prev_error);
   76   1      
   77   1          // 输出限幅
   78   1          if (pid->output > pid->max_output)
   79   1          {
   80   2              pid->output = pid->max_output;
   81   2          }
   82   1          else if (pid->output < -pid->min_output)
   83   1          {
   84   2              pid->output = -pid->min_output;
   85   2          }
   86   1      
   87   1          // 更新误差历史
   88   1          pid->prev_error = pid->error;
   89   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      1815     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =       216     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        36     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
