C251 COMPILER V5.60.0,  FUYA_euler                                                         20/11/25  19:23:21  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE FUYA_euler
OBJECT MODULE PLACED IN .\out_file\FUYA_euler.obj
COMPILER INVOKED BY: D:\keil_5\C251\BIN\C251.EXE FUYA_euler.c LARGE NOALIAS FLOAT64 WARNINGLEVEL(3) OPTIMIZE(0,SIZE) BRO
                    -WSE INCDIR(..\..\libraries\zf_common;..\..\libraries\zf_components;..\..\libraries\zf_device;..\..\libraries\zf_driver;.
                    -.\user;..\code) DEBUG PRINT(.\out_file\FUYA_euler.lst) OBJECT(.\out_file\FUYA_euler.obj) 

stmt  level    source

    1          #include "zf_common_headfile.h"
    2          #include <math.h>
    3          
    4          // 假设 vz 是从 IMU 更新的全局变量
    5          extern float vz;
    6          // 全局变量：负压状态与历史数据
    7          extern int fuya_date;        // 当前平滑输出的负压占空比
    8          extern float fuya_date_factor; // 目标负压占空比（未平滑）
    9          
   10          // 负压基准参数（单位：占空比，0~10000）
   11          #define DUTY_BOTTOM 2000.0f // 下切点（平地）基准
   12          #define DUTY_LEFT 4800.0f   // 左切点（竖直墙）基础值
   13          #define DUTY_RIGHT 4800.0f  // 右切点（竖直墙）基础值
   14          #define DUTY_TOP 3000.0f    // 上切点（倒立）基准
   15          
   16          // 平滑系数alpha（差异化策略）
   17          #define ALPHA_UP1 0.8f     // 下→左（上切快升）
   18          #define ALPHA_UP2 0.5f     // 左→上（上切缓降）
   19          #define ALPHA_DOWN1 0.4f   // 上→右（下切缓升）
   20          #define ALPHA_DOWN2 0.3f   // 右→下（下切缓降）
   21          #define ALPHA_DEFAULT 0.5f // 过渡阶段默认
   22          
   23          // 负压输出限幅
   24          // #define DUTY_MIN 1800.0f // 最小保障负压
   25          #define DUTY_MAX 5300.0f // 最大允许负压
   26          
   27          /**
   28           * @brief 负压吸附系统初始化函数
   29           */
   30          void fuya_init_euler(void)
   31          {
   32   1          pwm_init(PWMB_CH3_P52, 20000, 0); // 初始化风扇PWM（20kHz）
   33   1          fuya_date = DUTY_BOTTOM;          // 初始值设为下切点基准
   34   1      }
   35          
   36          /**
   37           * @brief 输出占空比到风扇（负压吸附执行器）
   38           * @param pwm 目标占空比（需为非负值）
   39           */
   40          static void fuya_motor_output(float pwm)
   41          {
   42   1          // 简单限幅，避免越界
   43   1          if (pwm < 0)
   44   1              pwm = 0;
   45   1          if (pwm > 10000.0f)
   46   1              pwm = 10000.0f;
   47   1          pwm_set_duty(PWMB_CH3_P52, (uint32)pwm);
   48   1      }
   49          
   50          /**
   51           * @brief 判断当前所处阶段 (基于 pitch 和 vz)
   52           * @param pitch 当前俯仰角 (假设抬头为负: 0 -> -90 -> -180)
   53           * @param vz Z轴重力分量 (1:平地, 0:垂直, -1:倒立)
   54           * @return 阶段编号：0=下→左, 1=左→上, 2=上→右, 3=右→下, 4=过渡
   55           */
   56          static uint8 get_current_phase_euler(float pitch, float vz)
   57          {
C251 COMPILER V5.60.0,  FUYA_euler                                                         20/11/25  19:23:21  PAGE 2   

   58   1          if (vz > 0) // 在环的下半部分
   59   1          {
   60   2              // 根据 pitch 的趋势可以判断方向，但这里简化为根据 pitch 的正负
   61   2              // 假设从右边下来时，经过底部，pitch 会从正变为负
   62   2              if (pitch < 0)
   63   2                  return 0; // 下 -> 左
   64   2              else
   65   2                  return 3; // 右 -> 下
   66   2          }
   67   1          else // 在环的上半部分
   68   1          {
   69   2              if (pitch < -90.0f)
   70   2                  return 2; // 上 -> 右
   71   2              else
   72   2                  return 1; // 左 -> 上
   73   2          }
   74   1          return 4; // 默认过渡
   75   1      }
   76          
   77          /**
   78           * @brief 计算当前阶段的基础目标负压 (基于 pitch)
   79           * @param phase 阶段编号
   80           * @param pitch 当前姿态
   81           * @return 基础目标负压
   82           */
   83          static float calculate_base_duty_euler(uint8 phase, float pitch)
   84          {
   85   1          float abs_pitch = func_abs(pitch);
   86   1      
   87   1          switch (phase)
   88   1          {
   89   2          case 0: // 下→左: pitch 从 0 → -90
   90   2              return DUTY_BOTTOM + (DUTY_LEFT - DUTY_BOTTOM) * (abs_pitch / 90.0f);
   91   2      
   92   2          case 1: // 左→上: pitch 从 -90 → -180
   93   2              return DUTY_LEFT + (DUTY_TOP - DUTY_LEFT) * ((abs_pitch - 90.0f) / 90.0f);
   94   2      
   95   2          case 2: // 上→右: pitch 从 -180 → -90
   96   2              return DUTY_TOP - (DUTY_TOP - DUTY_RIGHT) * ((180.0f - abs_pitch) / 90.0f);
   97   2      
   98   2          case 3: // 右→下: pitch 从 -90 → 0
   99   2              return DUTY_RIGHT - (DUTY_RIGHT - DUTY_BOTTOM) * (abs_pitch / 90.0f);
  100   2      
  101   2          default:              // 过渡阶段
  102   2              return fuya_date; // 保持上一时刻的值
  103   2          }
  104   1      }
  105          
  106          /**
  107           * @brief 根据阶段选择平滑系数alpha
  108           * @param phase 阶段编号
  109           * @return alpha值（0~1）
  110           */
  111          static float get_alpha_by_phase(uint8 phase)
  112          {
  113   1          switch (phase)
  114   1          {
  115   2          case 0:
  116   2              return ALPHA_UP1;
  117   2          case 1:
  118   2              return ALPHA_UP2;
  119   2          case 2:
  120   2              return ALPHA_DOWN1;
  121   2          case 3:
  122   2              return ALPHA_DOWN2;
  123   2          default:
C251 COMPILER V5.60.0,  FUYA_euler                                                         20/11/25  19:23:21  PAGE 3   

  124   2              return ALPHA_DEFAULT;
  125   2          }
  126   1      }
  127          
  128          /**
  129           * @brief 欧拉角版负压吸附占空比更新函数
  130           * @note 根据机体姿态（俯仰角pitch和vz）动态调整风扇吸力
  131           */
  132          void fuya_update_euler(void)
  133          {
  134   1          // 1. 获取姿态数据
  135   1          float pitch = Att_Angle.pit;
  136   1          // vz 是一个由IMU更新的全局变量
  137   1      
  138   1          // 2. 判断当前阶段
  139   1          uint8 phase = get_current_phase_euler(pitch, vz);
  140   1      
  141   1          // 3. 计算阶段基础负压
  142   1          float base_duty = calculate_base_duty_euler(phase, pitch);
  143   1      
  144   1          // 4. 负压输出限幅
  145   1          float target_duty = func_limit_ab(base_duty, fuya_xili, DUTY_MAX);
  146   1      
  147   1          // 5. 选择平滑系数
  148   1          float alpha = get_alpha_by_phase(phase);
  149   1      
  150   1          // 6. 一阶低通滤波
  151   1          fuya_date = fuya_date + alpha * (target_duty - fuya_date);
  152   1      
  153   1          // 7. 保存目标占空比
  154   1          fuya_date_factor = target_duty;
  155   1      
  156   1          // 8. 输出到风扇PWM
  157   1          fuya_motor_output(fuya_date);
  158   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       872     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =        39     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
