C251 COMPILER V5.60.0,  main                                                               21/11/25  22:44:39  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE main
OBJECT MODULE PLACED IN .\out_file\main.obj
COMPILER INVOKED BY: D:\keil_5\C251\BIN\C251.EXE ..\user\main.c LARGE NOALIAS FLOAT64 WARNINGLEVEL(3) OPTIMIZE(0,SIZE) B
                    -ROWSE INCDIR(..\..\libraries\zf_common;..\..\libraries\zf_components;..\..\libraries\zf_device;..\..\libraries\zf_driver
                    -;..\user;..\code) DEBUG PRINT(.\out_file\main.lst) OBJECT(.\out_file\main.obj) 

stmt  level    source

    1          /********************************************************************************************************
             -*************
    2           * VOFA+ 集成示例 - 基于您的 main.c 修改
    3           *
    4           * 功能：
    5           * 1. 接收 VOFA+ FireWater 协议命令
    6           * 2. 实时调整 PID 参数
    7           * 3. 控制电机运行
    8           ********************************************************************************************************
             -************/
    9          
   10          #include "zf_common_headfile.h"
   11          #include "vofa.h"
   12          #include <stdlib.h>
   13          
   14          // 函数声明
   15          void printf_adc();
   16          void printf_imu();
   17          void printf_date();
   18          void printf_speed_test();
   19          void handle_vofa_command(char *cmd);
   20          
   21          void main()
   22          {
   23   1              char vofa_cmd[32]; // VOFA 命令缓冲区（C89要求变量声明在开头）
   24   1      
   25   1              clock_init(SYSTEM_CLOCK_40M); // 务必保留
   26   1              debug_init();                             // 务必保留
   27   1              P32 = 1;                                          // 开启快速烧录
   28   1      
   29   1              // 初始化（wireless_uart_init 已在 int_user 中完成）
   30   1              int_user();
   31   1              vofa_init(); // 初始化 VOFA 解析器
   32   1      
   33   1              while (1)
   34   1              {
   35   2                      // ========== VOFA 命令处理 ==========
   36   2                      // 从 FIFO 读取并解析数据（使用系统自带的 wireless_uart_read_buffer）
   37   2                      vofa_parse_from_fifo();
   38   2      
   39   2                      // 检查是否有完整命令
   40   2                      if (vofa_get_command(vofa_cmd, 32))
   41   2                      {
   42   3                              handle_vofa_command(vofa_cmd);
   43   3                      }
   44   2      
   45   2                      // ========== 数据发送到 VOFA+ ==========
   46   2                      // 使用 FireWater 协议发送数据
   47   2                      // printf("%f,%f,%f,%f\n", speed_l, speed_r, test_speed, motor);
   48   2      
   49   2                      // ========== 其他显示功能（可选） ==========
   50   2                      // printf_date();
   51   2                      // printf_adc();
   52   2                      // printf_imu();
   53   2                      // printf_speed_test();
   54   2                      // Keystroke_Menu();
   55   2              }
C251 COMPILER V5.60.0,  main                                                               21/11/25  22:44:39  PAGE 2   

   56   1      }
   57          
   58          //-------------------------------------------------------------------------------------------------------
             -------------
   59          // 函数简介     处理 VOFA+ 接收到的命令
   60          // 参数说明     cmd         接收到的命令字符串
   61          // 返回参数     void
   62          // 使用示例     handle_vofa_command("KP=1.5");
   63          //-------------------------------------------------------------------------------------------------------
             -------------
   64          void handle_vofa_command(char *cmd)
   65          {
   66   1              char *eq_pos;
   67   1              char param_name[16];
   68   1              uint8 name_len;
   69   1              float value;
   70   1              uint8 i;
   71   1      
   72   1              // 初始化数组
   73   1              for (i = 0; i < 16; i++)
   74   1              {
   75   2                      param_name[i] = 0;
   76   2              }
   77   1      
   78   1              eq_pos = strchr(cmd, '=');
   79   1      
   80   1              if (eq_pos != NULL)
   81   1              {
   82   2                      // ========== 处理带参数的命令 ==========
   83   2                      name_len = (uint8)(eq_pos - cmd);
   84   2      
   85   2                      if (name_len < 16)
   86   2                      {
   87   3                              // 提取参数名
   88   3                              memcpy(param_name, cmd, name_len);
   89   3                              param_name[name_len] = '\0';
   90   3      
   91   3                              // 提取参数值
   92   3                              value = atof(eq_pos + 1);
   93   3      
   94   3                              // ========== 左电机 PID 参数 ==========
   95   3                              if (strcmp(param_name, "L_KP") == 0)
   96   3                              {
   97   4                                      motors_pid.left_PID.Kp = value;
   98   4                                      printf("Left Kp = %.2f\n", value);
   99   4                                      ips114_show_float(1 * 24, 18 * 0, value, 3, 2);
  100   4                              }
  101   3                              else if (strcmp(param_name, "L_KI") == 0)
  102   3                              {
  103   4                                      motors_pid.left_PID.Ki = value;
  104   4                                      printf("Left Ki = %.2f\n", value);
  105   4                              }
  106   3                              else if (strcmp(param_name, "L_KD") == 0)
  107   3                              {
  108   4                                      motors_pid.left_PID.Kd = value;
  109   4                                      printf("Left Kd = %.2f\n", value);
  110   4                              }
  111   3      
  112   3                              // ========== 右电机 PID 参数 ==========
  113   3                              else if (strcmp(param_name, "R_KP") == 0)
  114   3                              {
  115   4                                      motors_pid.right_PID.Kp = value;
  116   4                                      printf("Right Kp = %.2f\n", value);
  117   4                              }
  118   3                              else if (strcmp(param_name, "R_KI") == 0)
  119   3                              {
C251 COMPILER V5.60.0,  main                                                               21/11/25  22:44:39  PAGE 3   

  120   4                                      motors_pid.right_PID.Ki = value;
  121   4                                      printf("Right Ki = %.2f\n", value);
  122   4                              }
  123   3                              else if (strcmp(param_name, "R_KD") == 0)
  124   3                              {
  125   4                                      motors_pid.right_PID.Kd = value;
  126   4                                      printf("Right Kd = %.2f\n", value);
  127   4                              }
  128   3      
  129   3                              // ========== 位置环 PID 参数 ==========
  130   3                              else if (strcmp(param_name, "P_KP") == 0)
  131   3                              {
  132   4                                      motors_pid.Positional_PID.Kp = value;
  133   4                                      kp_Err = value; // 同步更新
  134   4                                      printf("Position Kp = %.2f\n", value);
  135   4                              }
  136   3                              else if (strcmp(param_name, "P_KI") == 0)
  137   3                              {
  138   4                                      motors_pid.Positional_PID.Ki = value;
  139   4                                      printf("Position Ki = %.2f\n", value);
  140   4                              }
  141   3                              else if (strcmp(param_name, "P_KD") == 0)
  142   3                              {
  143   4                                      motors_pid.Positional_PID.Kd = value;
  144   4                                      kd_Err = value; // 同步更新
  145   4                                      printf("Position Kd = %.2f\n", value);
  146   4                              }
  147   3                              else if (strcmp(param_name, "KD_GYRO") == 0)
  148   3                              {
  149   4                                      kd_gyro = value;
  150   4                                      motors_pid.Positional_PID.Ki = value; // 陀螺仪微分系数
  151   4                                      printf("Kd Gyro = %.2f\n", value);
  152   4                              }
  153   3      
  154   3                              // ========== 速度控制 ==========
  155   3                              else if (strcmp(param_name, "SPEED") == 0)
  156   3                              {
  157   4                                      test_speed = value;
  158   4                                      printf("Target Speed = %.2f\n", value);
  159   4                              }
  160   3                              else if (strcmp(param_name, "RP") == 0)
  161   3                              {
  162   4                                      // 处理 RP 参数（根据您的实际需求修改）
  163   4                                      test_speed = value; // 或者改成其他变量
  164   4                                      printf("RP = %.2f\n", value);
  165   4                              }
  166   3                              else if (strcmp(param_name, "MOTOR") == 0)
  167   3                              {
  168   4                                      motor = value;
  169   4                                      printf("Motor = %.2f\n", value);
  170   4                              }
  171   3                              else if (strcmp(param_name, "SPEED_RUN") == 0)
  172   3                              {
  173   4                                      speed_run = value;
  174   4                                      printf("Speed Run = %.2f\n", value);
  175   4                              }
  176   3      
  177   3                              // ========== 其他参数 ==========
  178   3                              else if (strcmp(param_name, "ERR") == 0)
  179   3                              {
  180   4                                      Err = value;
  181   4                                      printf("Error = %.2f\n", value);
  182   4                              }
  183   3                              else
  184   3                              {
  185   4                                      printf("Unknown parameter: %s = %.2f\n", param_name, value);
C251 COMPILER V5.60.0,  main                                                               21/11/25  22:44:39  PAGE 4   

  186   4                              }
  187   3                      }
  188   2              }
  189   1              else
  190   1              {
  191   2                      // ========== 处理无参数的命令 ==========
  192   2                      if (strcmp(cmd, "START") == 0)
  193   2                      {
  194   3                              // 启动电机
  195   3                              printf("Motor START\n");
  196   3                              // 可以添加启动标志位
  197   3                      }
  198   2                      else if (strcmp(cmd, "STOP") == 0)
  199   2                      {
  200   3                              // 停止电机
  201   3                              motor = 0;
  202   3                              speed_run = 0;
  203   3                              test_speed = 0;
  204   3                              printf("Motor STOP\n");
  205   3                      }
  206   2                      else if (strcmp(cmd, "RESET") == 0)
  207   2                      {
  208   3                              // 复位系统
  209   3                              IAP_CONTR = 0x60; // 软件复位
  210   3                      }
  211   2                      else if (strcmp(cmd, "SAVE") == 0)
  212   2                      {
  213   3                              // 保存参数到 EEPROM
  214   3                              eeprom_flash();
  215   3                              printf("Parameters saved\n");
  216   3                      }
  217   2                      else if (strcmp(cmd, "LOAD") == 0)
  218   2                      {
  219   3                              // 从 EEPROM 加载参数
  220   3                              eeprom_init();
  221   3                              printf("Parameters loaded\n");
  222   3                      }
  223   2                      else if (strcmp(cmd, "INFO") == 0)
  224   2                      {
  225   3                              // 打印当前参数信息
  226   3                              printf("=== Current Parameters ===\n");
  227   3                              printf("Left PID: %.2f, %.2f, %.2f\n",
  228   3                                         motors_pid.left_PID.Kp,
  229   3                                         motors_pid.left_PID.Ki,
  230   3                                         motors_pid.left_PID.Kd);
  231   3                              printf("Right PID: %.2f, %.2f, %.2f\n",
  232   3                                         motors_pid.right_PID.Kp,
  233   3                                         motors_pid.right_PID.Ki,
  234   3                                         motors_pid.right_PID.Kd);
  235   3                              printf("Speed: %.2f\n", test_speed);
  236   3                      }
  237   2                      else
  238   2                      {
  239   3                              printf("Unknown command: %s\n", cmd);
  240   3                      }
  241   2              }
  242   1      }
  243          
  244          // 原有的显示函数保持不变
  245          void printf_date()
  246          {
  247   1              ips114_show_float(1 * 24, 18 * 0, Err, 3, 1);
  248   1              ips114_show_float(1 * 24, 18 * 1, ad1, 4, 1);
  249   1              ips114_show_float(1 * 24, 18 * 2, ad2, 4, 1);
  250   1              ips114_show_float(1 * 24, 18 * 3, ad3, 4, 1);
  251   1              ips114_show_float(1 * 24, 18 * 4, ad4, 4, 1);
C251 COMPILER V5.60.0,  main                                                               21/11/25  22:44:39  PAGE 5   

  252   1      
  253   1              ips114_show_float(3 * 24, 18 * 0, motor, 3, 1);
  254   1              ips114_show_float(3 * 24, 18 * 1, speed_run + motor, 3, 1);
  255   1              ips114_show_float(3 * 24, 18 * 2, speed_run - motor, 3, 1);
  256   1      
  257   1              ips114_show_float(6 * 24, 18 * 1, adc_convert(ADC_CH13_P05) * 0.0092, 3, 2);
  258   1      }
  259          
  260          void printf_adc()
  261          {
  262   1              ips114_show_float(1 * 24, 18 * 0, ad1, 3, 1);
  263   1              ips114_show_float(1 * 24, 18 * 1, ad2, 3, 1);
  264   1              ips114_show_float(1 * 24, 18 * 2, ad3, 3, 1);
  265   1              ips114_show_float(1 * 24, 18 * 3, ad4, 3, 1);
  266   1      
  267   1              ips114_show_float(1 * 24, 18 * 6, Err, 4, 1);
  268   1      
  269   1              ips114_show_float(3 * 24, 18 * 0, RAW[0], 4, 1);
  270   1              ips114_show_float(3 * 24, 18 * 1, RAW[1], 4, 1);
  271   1              ips114_show_float(3 * 24, 18 * 2, RAW[2], 4, 1);
  272   1              ips114_show_float(3 * 24, 18 * 3, RAW[3], 4, 1);
  273   1      
  274   1              ips114_show_float(7 * 24, 18 * 0, MA[0], 4, 1);
  275   1              ips114_show_float(7 * 24, 18 * 1, MA[1], 4, 1);
  276   1              ips114_show_float(7 * 24, 18 * 2, MA[2], 4, 1);
  277   1              ips114_show_float(7 * 24, 18 * 3, MA[3], 4, 1);
  278   1      }
  279          
  280          void printf_imu()
  281          {
  282   1              ips114_show_float(4 * 24, 18 * 0, Gyr_filt.X, 4, 2);
  283   1              ips114_show_float(4 * 24, 18 * 1, Gyr_filt.Y, 4, 2);
  284   1              ips114_show_float(4 * 24, 18 * 2, Gyr_filt.Z, 4, 2);
  285   1              ips114_show_float(4 * 24, 18 * 4, Acc_filt.X, 4, 2);
  286   1              ips114_show_float(4 * 24, 18 * 5, Acc_filt.Y, 4, 2);
  287   1              ips114_show_float(4 * 24, 18 * 6, Acc_filt.Z, 4, 2);
  288   1              ips114_show_float(7 * 24, 18 * 0, vx, 4, 2);
  289   1              ips114_show_float(7 * 24, 18 * 1, vy, 4, 2);
  290   1              ips114_show_float(7 * 24, 18 * 2, vz, 4, 2);
  291   1              ips114_show_int32(7 * 24, 18 * 4, fuya_date, 4);
  292   1              ips114_show_int32(7 * 24, 18 * 5, phase, 4);
  293   1      }
  294          
  295          void printf_speed_test()
  296          {
  297   1              ips114_show_float(0, 0, test_speed, 6, 1);
  298   1              ips114_show_float(0, 15, motor, 6, 1);
  299   1              ips114_show_float(0, 35, speed_l, 6, 1);
  300   1              ips114_show_float(0, 55, speed_r, 6, 1);
  301   1              ips114_show_int32(0, 75, imu660ra_gyro_z, 6);
  302   1              ips114_show_int32(0, 95, imu660ra_gyro_z * 0.01, 6);
  303   1              printf("%f,%f,%f,%f\n", test_speed, speed_l, speed_r, 0.0);
  304   1      }
  305          
  306          void printf_butten_test()
  307          {
  308   1              ips114_show_int32(4 * 24, 18 * 0, P33, 1);
  309   1              ips114_show_int32(4 * 24, 18 * 1, P34, 1);
  310   1              ips114_show_int32(4 * 24, 18 * 2, P35, 1);
  311   1              ips114_show_int32(4 * 24, 18 * 4, P36, 1);
  312   1              ips114_show_int32(4 * 24, 18 * 5, P37, 1);
  313   1              ips114_show_int32(4 * 24, 18 * 6, flat_statr, 2);
  314   1      }
  315          
  316          /*******************************************************************************
  317           * VOFA+ 命令示例：
C251 COMPILER V5.60.0,  main                                                               21/11/25  22:44:39  PAGE 6   

  318           *
  319           * 调整左电机 PID:
  320           *   L_KP=100!
  321           *   L_KI=40!
  322           *   L_KD=0!
  323           *
  324           * 调整右电机 PID:
  325           *   R_KP=100!
  326           *   R_KI=40!
  327           *
  328           * 调整位置环 PID:
  329           *   P_KP=0.3!
  330           *   P_KI=0.1!
  331           *   P_KD=4!
  332           *   KD_GYRO=2.5!
  333           *
  334           * 控制命令:
  335           *   SPEED=50!      - 设置目标速度
  336           *   START!         - 启动电机
  337           *   STOP!          - 停止电机
  338           *   SAVE!          - 保存参数
  339           *   INFO!          - 查看当前参数
  340           *   RESET!         - 复位系统
  341           ******************************************************************************/


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      4433     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =        62     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =       593     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
