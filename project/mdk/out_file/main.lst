C251 COMPILER V5.60.0,  main                                                               23/11/25  22:30:55  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE main
OBJECT MODULE PLACED IN .\out_file\main.obj
COMPILER INVOKED BY: D:\keil_5\C251\BIN\C251.EXE ..\user\main.c LARGE NOALIAS FLOAT64 WARNINGLEVEL(3) OPTIMIZE(0,SIZE) B
                    -ROWSE INCDIR(..\..\libraries\zf_common;..\..\libraries\zf_components;..\..\libraries\zf_device;..\..\libraries\zf_driver
                    -;..\user;..\code) DEBUG PRINT(.\out_file\main.lst) OBJECT(.\out_file\main.obj) 

stmt  level    source

    1          #include "zf_common_headfile.h"
    2          #include "vofa.h"
    3          #include <stdlib.h>
    4          
    5          // 打印与调试函数声明
    6          void printf_adc();
    7          void printf_imu();
    8          void printf_date();
    9          void printf_speed_test();
   10          
   11          void main()
   12          {
   13   1              char vofa_cmd[32]; // VOFA 命令缓存
   14   1      
   15   1              clock_init(SYSTEM_CLOCK_40M); // 时钟初始化
   16   1              debug_init();                             // 调试接口初始化
   17   1              P32 = 1;                                          // 上电安全记录（示例）
   18   1      
   19   1              // 初始化（wireless_uart_init 已在 int_user 中完成）
   20   1              int_user();
   21   1              vofa_init(); // 初始化 VOFA 通信（可选）
   22   1      
   23   1              while (1)
   24   1              {
   25   2                      // ========== 处理 VOFA 命令 ==========
   26   2                      // 从 FIFO 读取串口数据，使用系统提供的 wireless_uart_read_buffer
   27   2                      vofa_parse_from_fifo();
   28   2      
   29   2                      //      // 检查是否解析到完整命令
   30   2                      if (vofa_get_command(vofa_cmd, 32))
   31   2                      {
   32   3                              handle_vofa_command(vofa_cmd);
   33   3                      }
   34   2      
   35   2                      // ========== 数据发送到 VOFA+ ==========
   36   2                      // 使用 FireWater 协议发送数据
   37   2                      // printf("%f,%f,%f,%f\n", speed_l, speed_r, test_speed, PID.steer.output);
   38   2      
   39   2                      // ========== 显示调试功能（按需选择） ==========
   40   2                      // printf_date();
   41   2                      // printf_adc();
   42   2                      // printf_imu();
   43   2                      // printf_speed_test();
   44   2      //               Keystroke_Menu();
   45   2              }
   46   1      }
   47          
   48          // 原有的数据显示函数（已部分调整）
   49          void printf_date()
   50          {
   51   1              // 优化：Err 与电感归一化值使用整数显示，避免浮点格式化开销
   52   1              ips114_show_int32(1 * 24, 18 * 0, Err, 3);
   53   1              ips114_show_int32(1 * 24, 18 * 1, ad1, 3);
   54   1              ips114_show_int32(1 * 24, 18 * 2, ad2, 3);
   55   1              ips114_show_int32(1 * 24, 18 * 3, ad3, 3);
   56   1              ips114_show_int32(1 * 24, 18 * 4, ad4, 3);
   57   1      
C251 COMPILER V5.60.0,  main                                                               23/11/25  22:30:55  PAGE 2   

   58   1              ips114_show_float(3 * 24, 18 * 0, PID.steer.output, 3, 1);
   59   1              ips114_show_float(3 * 24, 18 * 1, speed_run + PID.steer.output, 3, 1);
   60   1              ips114_show_float(3 * 24, 18 * 2, speed_run - PID.steer.output, 3, 1);
   61   1      
   62   1              // 电压使用 mV 整数显示（dianya 已在 ADC.c 转为 mV 整数）
   63   1              ips114_show_int32(6 * 24, 18 * 1, dianya, 5);
   64   1      }
   65          
   66          void printf_adc()
   67          {
   68   1              // 电感归一化值（0-100）整数显示
   69   1              ips114_show_int32(1 * 24, 18 * 0, ad1, 3);
   70   1              ips114_show_int32(1 * 24, 18 * 1, ad2, 3);
   71   1              ips114_show_int32(1 * 24, 18 * 2, ad3, 3);
   72   1              ips114_show_int32(1 * 24, 18 * 3, ad4, 3);
   73   1      
   74   1              ips114_show_int32(1 * 24, 18 * 6, Err, 4);
   75   1      
   76   1              // 原始 ADC 计数显示（整数）
   77   1              ips114_show_int32(3 * 24, 18 * 0, RAW[0], 4);
   78   1              ips114_show_int32(3 * 24, 18 * 1, RAW[1], 4);
   79   1              ips114_show_int32(3 * 24, 18 * 2, RAW[2], 4);
   80   1              ips114_show_int32(3 * 24, 18 * 3, RAW[3], 4);
   81   1      
   82   1              // 标定最大值显示（整数）
   83   1              ips114_show_int32(7 * 24, 18 * 0, MA[0], 4);
   84   1              ips114_show_int32(7 * 24, 18 * 1, MA[1], 4);
   85   1              ips114_show_int32(7 * 24, 18 * 2, MA[2], 4);
   86   1              ips114_show_int32(7 * 24, 18 * 3, MA[3], 4);
   87   1      }
   88          
   89          void printf_imu()
   90          {
   91   1              ips114_show_float(4 * 24, 18 * 0, Gyr_filt.X, 4, 2);
   92   1              ips114_show_float(4 * 24, 18 * 1, Gyr_filt.Y, 4, 2);
   93   1              ips114_show_float(4 * 24, 18 * 2, Gyr_filt.Z, 4, 2);
   94   1              ips114_show_float(4 * 24, 18 * 4, Acc_filt.X, 4, 2);
   95   1              ips114_show_float(4 * 24, 18 * 5, Acc_filt.Y, 4, 2);
   96   1              ips114_show_float(4 * 24, 18 * 6, Acc_filt.Z, 4, 2);
   97   1              ips114_show_float(7 * 24, 18 * 0, vx, 4, 2);
   98   1              ips114_show_float(7 * 24, 18 * 1, vy, 4, 2);
   99   1              ips114_show_float(7 * 24, 18 * 2, vz, 4, 2);
  100   1              ips114_show_int32(7 * 24, 18 * 4, fuya_date, 4);
  101   1              ips114_show_int32(7 * 24, 18 * 5, phase, 4);
  102   1      }
  103          
  104          void printf_speed_test()
  105          {
  106   1              ips114_show_float(0, 0, test_speed, 6, 1);
  107   1              ips114_show_float(0, 15, PID.steer.output, 6, 1);
  108   1              ips114_show_float(0, 35, speed_l, 6, 1);
  109   1              ips114_show_float(0, 55, speed_r, 6, 1);
  110   1              ips114_show_int32(0, 75, imu660ra_gyro_z, 6);
  111   1              ips114_show_int32(0, 95, imu660ra_gyro_z * 0.01, 6);
  112   1              printf("%f,%f,%f,%f\n", test_speed, speed_l, speed_r, 0.0);
  113   1      }
  114          
  115          void printf_butten_test()
  116          {
  117   1              ips114_show_int32(4 * 24, 18 * 0, P33, 1);
  118   1              ips114_show_int32(4 * 24, 18 * 1, P34, 1);
  119   1              ips114_show_int32(4 * 24, 18 * 2, P35, 1);
  120   1              ips114_show_int32(4 * 24, 18 * 4, P36, 1);
  121   1              ips114_show_int32(4 * 24, 18 * 5, P37, 1);
  122   1              ips114_show_int32(4 * 24, 18 * 6, flat_statr, 2);
  123   1      }
C251 COMPILER V5.60.0,  main                                                               23/11/25  22:30:55  PAGE 3   

  124          
  125          /*******************************************************************************
  126           * VOFA+ 使用示例
  127           *
  128           * 左轮 PID_Direction:
  129           *   L_KP=100!
  130           *   L_KI=40!
  131           *   L_KD=0!
  132           *
  133           * 右轮 PID_Direction:
  134           *   R_KP=100!
  135           *   R_KI=40!
  136           *
  137           * 位置式 PID_Direction:
  138           *   P_KP=0.3!
  139           *   P_KI=0.1!
  140           *   P_KD=4!
  141           *   KD_GYRO=2.5!
  142           *
  143           * 运行控制:
  144           *   SPEED=50!      - 设置目标速度
  145           *   START!         - 启动电机
  146           *   STOP!          - 停止电机
  147           *   SAVE!          - 保存参数
  148           *   INFO!          - 查看当前参数
  149           *   RESET!         - 软复位系统
  150           ******************************************************************************/


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      1661     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =        32     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        15     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
