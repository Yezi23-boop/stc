C251 COMPILER V5.60.0,  eeprom                                                             21/11/25  22:30:33  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE eeprom
OBJECT MODULE PLACED IN .\out_file\eeprom.obj
COMPILER INVOKED BY: D:\keil_5\C251\BIN\C251.EXE ..\user\eeprom.c LARGE NOALIAS FLOAT64 WARNINGLEVEL(3) OPTIMIZE(0,SIZE)
                    - BROWSE INCDIR(..\..\libraries\zf_common;..\..\libraries\zf_components;..\..\libraries\zf_device;..\..\libraries\zf_driv
                    -er;..\user;..\code) DEBUG PRINT(.\out_file\eeprom.lst) OBJECT(.\out_file\eeprom.obj) 

stmt  level    source

    1          #include "zf_common_headfile.h"
    2          
    3          /*********************************************
    4           * EEPROM系统基础变量定义
    5           *********************************************/
    6          uint8 date_buff[400]; // eeprom数据数组
    7          uint8 eeprom_init_time = 0;
    8          
    9          /*********************************************
   10           * 需要被修改的参数
   11           *********************************************/
   12          // 启动配置参数
   13          int16 start_flag = 0;
   14          int16 circle_flags = 0;
   15          // PID速度控制参数
   16          float kp_Err = 0.15f;      // 4.40f//
   17          float kd_Err = 3.0f;      // 7.30f//
   18          float speed_run = 25.0;   // 55//
   19          float kd_gyro = 0.0;      // 270.0//
   20          float fuya_xili = 2000.0; // 60.0//
   21          float pwm_filter = 0.7;   // 0.90//
   22          
   23          // PID角度控制参数
   24          float kp_Angle = 0.8;          // 0.5//
   25          float kd_Angle = 2.6;          // 2.2//
   26          float limiting_Angle = 130.0f; //
   27          float A_1 = 0.50f;             // 1.00f
   28          float B_1 = 0.20f;             // 0.60f
   29          float C_l = 1.00f;        // 0.005f
   30          
   31          // 圆环控制参数
   32          float ring_encoder = 15;           // 15
   33          float pre_ring_Gyro_set = 210;     // 200
   34          float in_ring_Gyroz = 220;         // 230
   35          float pre_out_ring_Gyro_set = 170; // 150
   36          float pre_out_ring_Gyroz = 350;    // 350
   37          float pre_out_ring_encoder = 30;   // 30
   38          /*********************************************
   39           * EEPROM初始化函数
   40           *********************************************/
   41          void eeprom_init()
   42          {
   43   1          iap_init(); // 初始化EEPROM
   44   1      
   45   1          iap_read_buff(0x00, date_buff, 400); // 从EEPROM中读取数据
   46   1      
   47   1          eeprom_init_time = read_int(0); // eeprom没有被填充，则会读到垃圾值
   48   1      
   49   1          if (eeprom_init_time != 1) // 初次启动，eeprom_init_time为垃圾值，if成立
   50   1          {
   51   2              eeprom_init_time = 1;
   52   2              save_int(eeprom_init_time, 0); // 填充eeprom_init_time的值到eeprom
   53   2      
   54   2              eeprom_flash(); // 填充源码变量初始化的值到eeprom
   55   2          }
   56   1          else // 非初次启动，读取eeprom用于赋值变量
   57   1          {
C251 COMPILER V5.60.0,  eeprom                                                             21/11/25  22:30:33  PAGE 2   

   58   2              // 启动配置参数
   59   2              start_flag = read_int(1);
   60   2              circle_flags = read_int(2);
   61   2      
   62   2              // PID速度控制参数
   63   2              kp_Err = read_float(4);
   64   2              fuya_xili = read_float(5);
   65   2              kd_Err = read_float(6);
   66   2              pwm_filter = read_float(7);
   67   2              speed_run = read_float(8);
   68   2              kd_gyro = read_float(9);
   69   2      
   70   2              // PID角度控制参数
   71   2              kp_Angle = read_float(10);
   72   2              kd_Angle = read_float(11);
   73   2              limiting_Angle = read_float(12);
   74   2              B_1 = read_float(13);
   75   2              C_l = read_float(14);
   76   2              A_1 = read_float(15);
   77   2      
   78   2              // 圆环控制参数
   79   2              ring_encoder = read_float(16);
   80   2              pre_ring_Gyro_set = read_float(17);
   81   2              in_ring_Gyroz = read_float(18);
   82   2              pre_out_ring_Gyro_set = read_float(19);
   83   2              pre_out_ring_Gyroz = read_float(20);
   84   2              pre_out_ring_encoder = read_float(21);
   85   2          }
   86   1      }
   87          
   88          /*********************************************
   89           * 刷写保存数据到eeprom
   90           *********************************************/
   91          void eeprom_flash()
   92          {
   93   1          // 启动配置参数
   94   1          save_int(start_flag, 1);
   95   1          save_int(circle_flags, 2);
   96   1      
   97   1          // PID速度控制参数
   98   1          save_float(kp_Err, 4);
   99   1          save_float(fuya_xili, 5);
  100   1          save_float(kd_Err, 6);
  101   1          save_float(pwm_filter, 7);
  102   1          save_float(speed_run, 8);
  103   1          save_float(kd_gyro, 9);
  104   1      
  105   1          // PID角度控制参数
  106   1          save_float(kp_Angle, 10);
  107   1          save_float(kd_Angle, 11);
  108   1          save_float(limiting_Angle, 12);
  109   1          save_float(B_1, 13);
  110   1          save_float(C_l, 14);
  111   1          save_float(A_1, 15);
  112   1      
  113   1          // 圆环控制参数
  114   1          save_float(ring_encoder, 16);
  115   1          save_float(pre_ring_Gyro_set, 17);
  116   1          save_float(in_ring_Gyroz, 18);
  117   1          save_float(pre_out_ring_Gyro_set, 19);
  118   1          save_float(pre_out_ring_Gyroz, 20);
  119   1          save_float(pre_out_ring_encoder, 21);
  120   1      }
  121          
  122          /*********************************************
  123           * EEPROM底层读写函数
C251 COMPILER V5.60.0,  eeprom                                                             21/11/25  22:30:33  PAGE 3   

  124           *********************************************/
  125          void save_int(int32 input, uint8 value_bit)
  126          {
  127   1          uint8 i;
  128   1          uint8 begin = value_bit * 4;
  129   1          uint8 *p = (uint8 *)&input;
  130   1      
  131   1          for (i = 0; i < 4; i++)
  132   1          {
  133   2              date_buff[begin++] = *(p + i);
  134   2          }
  135   1          extern_iap_write_buff(0x00, date_buff, 400);
  136   1      }
  137          
  138          int32 read_int(uint8 value_bit)
  139          {
  140   1          uint8 i;
  141   1          uint8 begin = value_bit * 4;
  142   1          int32 output;
  143   1          uint8 *p = (uint8 *)&output;
  144   1      
  145   1          for (i = 0; i < 4; i++)
  146   1          {
  147   2              *(p + i) = date_buff[begin++];
  148   2          }
  149   1          return output;
  150   1      }
  151          
  152          void save_float(float input, uint8 value_bit)
  153          {
  154   1          uint8 i;
  155   1          uint8 begin = value_bit * 4;
  156   1          uint8 *p = (uint8 *)&input;
  157   1      
  158   1          for (i = 0; i < 4; i++)
  159   1          {
  160   2              date_buff[begin++] = *(p + i);
  161   2          }
  162   1          extern_iap_write_buff(0x00, date_buff, 400);
  163   1      }
  164          
  165          float read_float(uint8 value_bit)
  166          {
  167   1          uint8 i;
  168   1          uint8 begin = value_bit * 4;
  169   1          float output;
  170   1          uint8 *p = (uint8 *)&output;
  171   1      
  172   1          for (i = 0; i < 4; i++)
  173   1          {
  174   2              *(p + i) = date_buff[begin++];
  175   2          }
  176   1          return output;
  177   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      1201     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =       521     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
C251 COMPILER V5.60.0,  eeprom                                                             21/11/25  22:30:33  PAGE 4   

  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =       182     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
