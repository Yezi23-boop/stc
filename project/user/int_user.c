#include "zf_common_headfile.h"
#define TIME_0 5  // ?????0?§Ø????
#define TIME_1 20 // ?????1?§Ø????
void int_user(void)
{
	// ?????§Õ??????? ?????????????????
	imu660ra_init(); // ????? IMU660RA
	eeprom_init();
	pit_ms_init(TIM0_PIT, TIME_0);
	pit_ms_init(TIM1_PIT, TIME_1);
	encoder_dir_init(TIM3_ENCOEDER, IO_P46, TIM3_ENCOEDER_P04); // ????????????
	encoder_dir_init(TIM4_ENCOEDER, IO_P42, TIM4_ENCOEDER_P06); // ????????????
	adc_init(ADC_CH13_P05, ADC_8BIT);
	adc_init(ADC_CH0_P10, ADC_12BIT);
	adc_init(ADC_CH1_P11, ADC_12BIT);
	adc_init(ADC_CH8_P00, ADC_12BIT);
	adc_init(ADC_CH9_P01, ADC_12BIT);
	motor_Init();		  // ????????
	fuya_Init();		  // ???????????
	wireless_uart_init(); // ???????????
						  //	pwm_init(PWMA_CH4N_P07, 3800, 1);	// ???????????
	// ???????????????????????????
	pid_speed_init(&PID.left_speed, 100, 40, 0, 8000, 8000); // ?????????????
	pid_speed_init(&PID.right_speed, 100, 40, 0, 8000, 8000);
	// ¦Ë????????????????????? Kp, Kd, kd_gyro
	// ?????? (kp_Err, kd_gyro, kd_Err, 45,45)?????? kd_gyro ?????????kd_Err ???????
	pid_steer_init(&PID.steer, kp_Err, kd_Err, kd_gyro, 45, 45); // ???????
	ips114_init();
}

/*********************************************
 *????????????????
 *????????offset_init()
 *?????????????????
 *?????2024/11/26
 *????????
 *********************************************/
float Gyrox = 0;
float Gyroy = 0;
float Gyroz = 0;
float acc_x = 0;
float acc_y = 0;
float acc_z = 0;
float Gyro_offset_x = 0;
float Gyro_offset_y = 0;
float Gyro_offset_z = 0;
float acc_offset_x = 0;
float acc_offset_y = 0;
float acc_offset_z = 0;
void offset_init(void)
{
	int rt = 50;
	int i;
	imu660ra_init();	 // ??????
	system_delay_init(); // ???
	for (i = 0; i < rt; i++)
	{
		imu660ra_get_gyro();
		imu660ra_get_acc();
		Gyro_offset_x += imu660ra_gyro_transition(imu660ra_gyro_x);
		Gyro_offset_y += imu660ra_gyro_transition(imu660ra_gyro_y);
		Gyro_offset_z += imu660ra_gyro_transition(imu660ra_gyro_z);
		acc_offset_x += (imu660ra_acc_transition(imu660ra_acc_x));
		acc_offset_y += (imu660ra_acc_transition(imu660ra_acc_y));
		acc_offset_z += (imu660ra_acc_transition(imu660ra_acc_z));
		system_delay_ms(5);
	}
	Gyro_offset_x = Gyro_offset_x / rt;
	Gyro_offset_y = Gyro_offset_y / rt;
	Gyro_offset_z = Gyro_offset_z / rt;
	acc_offset_x = acc_offset_x / rt;
	acc_offset_y = acc_offset_y / rt;
	acc_offset_z = acc_offset_z / rt;
}
