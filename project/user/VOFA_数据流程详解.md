# VOFA+ FireWater 协议数据接收与解析流程

## 完整数据流程图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        VOFA+ 上位机                                  │
│                                                                      │
│  用户输入: "PR=2.32!"                                                │
│  转换为 ASCII: [0x50, 0x52, 0x3D, 0x32, 0x2E, 0x33, 0x32, 0x21]    │
└──────────────────────────┬──────────────────────────────────────────┘
                           │ 无线串口发送
                           ↓
┌─────────────────────────────────────────────────────────────────────┐
│                     单片机硬件串口 (UART3)                           │
│                                                                      │
│  接收字节: 0x50 → 0x52 → 0x3D → 0x32 → 0x2E → 0x33 → 0x32 → 0x21  │
└──────────────────────────┬──────────────────────────────────────────┘
                           │ 每接收一个字节触发中断
                           ↓
┌─────────────────────────────────────────────────────────────────────┐
│              DMA_UART3_IRQHandler() 中断服务函数                     │
│                        (isr.c 文件)                                  │
│                                                                      │
│  1. DMA_UR3R_STA & 0x01  (检查接收完成标志)                         │
│  2. 读取: uart_rx_buff[UART_3][0]                                   │
│  3. 调用: uart3_irq_handler(接收字节)                               │
└──────────────────────────┬──────────────────────────────────────────┘
                           │
                           ↓
┌─────────────────────────────────────────────────────────────────────┐
│           wireless_uart_callback() 回调函数                          │
│            (zf_device_wireless_uart.c 文件)                          │
│                                                                      │
│  1. fifo_write_buffer(&wireless_uart_fifo, &uart_dat, 1)           │
│  2. vofa_parse_byte(uart_dat);  ← 添加这一行                       │
└──────────────────────────┬──────────────────────────────────────────┘
                           │ 逐字节传递
                           ↓
┌─────────────────────────────────────────────────────────────────────┐
│               vofa_parse_byte() 解析函数                             │
│                      (vofa.c 文件)                                   │
│                                                                      │
│  状态机处理:                                                         │
│  ┌────────────────────────────────────────┐                        │
│  │ 接收字节 → 存入缓冲区                  │                        │
│  │                                         │                        │
│  │ buffer[0] = 'P' (0x50)                 │                        │
│  │ buffer[1] = 'R' (0x52)                 │                        │
│  │ buffer[2] = '=' (0x3D)                 │                        │
│  │ buffer[3] = '2' (0x32)                 │                        │
│  │ buffer[4] = '.' (0x2E)                 │                        │
│  │ buffer[5] = '3' (0x33)                 │                        │
│  │ buffer[6] = '2' (0x32)                 │                        │
│  │ buffer[7] = '!' (0x21) ← 检测到帧尾   │                        │
│  │                                         │                        │
│  │ 动作:                                   │                        │
│  │ 1. 添加字符串结束符 '\0'               │                        │
│  │ 2. 复制到 cmd_buffer: "PR=2.32"        │                        │
│  │ 3. 状态 = VOFA_PARSE_COMPLETE          │                        │
│  │ 4. 重置 index = 0                      │                        │
│  └────────────────────────────────────────┘                        │
└──────────────────────────┬──────────────────────────────────────────┘
                           │ 等待主循环读取
                           ↓
┌─────────────────────────────────────────────────────────────────────┐
│                    main() 主循环                                     │
│                      (main.c 文件)                                   │
│                                                                      │
│  while(1)                                                           │
│  {                                                                  │
│      char vofa_cmd[32];                                             │
│                                                                      │
│      // 检查是否有新命令                                            │
│      if(vofa_get_command(vofa_cmd, 32))                            │
│      {                                                              │
│          ┌──────────────────────────────────┐                      │
│          │ vofa_cmd = "PR=2.32"             │                      │
│          │                                   │                      │
│          │ 调用: handle_vofa_command()      │                      │
│          └──────────────────────────────────┘                      │
│      }                                                              │
│  }                                                                  │
└──────────────────────────┬──────────────────────────────────────────┘
                           │
                           ↓
┌─────────────────────────────────────────────────────────────────────┐
│            handle_vofa_command() 命令处理函数                        │
│                      (main.c 文件)                                   │
│                                                                      │
│  输入: cmd = "PR=2.32"                                              │
│                                                                      │
│  解析过程:                                                           │
│  ┌────────────────────────────────────────┐                        │
│  │ 1. 查找 '=' 位置                       │                        │
│  │    eq_pos = 指向 '=' 的位置            │                        │
│  │                                         │                        │
│  │ 2. 提取参数名                          │                        │
│  │    param_name = "PR"                   │                        │
│  │    (从开头到 '=' 之前)                 │                        │
│  │                                         │                        │
│  │ 3. 提取参数值                          │                        │
│  │    value = atof("2.32")                │                        │
│  │    value = 2.32                        │                        │
│  │                                         │                        │
│  │ 4. 根据参数名执行操作                  │                        │
│  │    if(strcmp(param_name, "PR") == 0)   │                        │
│  │    {                                    │                        │
│  │        // 设置 PR 参数                 │                        │
│  │        PR_value = 2.32;                │                        │
│  │    }                                    │                        │
│  └────────────────────────────────────────┘                        │
└─────────────────────────────────────────────────────────────────────┘
```

## 关键数据结构

### vofa_data_struct 结构体
```c
typedef struct {
    uint8 buffer[64];         // 接收缓冲区: ['P','R','=','2','.','3','2','\0']
    uint8 cmd_buffer[32];     // 命令缓冲区: "PR=2.32"
    uint8 index;              // 当前写入位置: 0-7
    uint8 cmd_len;            // 命令长度: 7
    vofa_parse_state_enum state; // 状态: COMPLETE
} vofa_data_struct;
```

## 状态转换图

```
IDLE (空闲)
  │
  │ 接收到非 '!' 字节
  ↓
RECEIVING (接收中)
  │
  │ 继续接收非 '!' 字节
  ↓
RECEIVING
  │
  │ 接收到 '!' 字节
  ↓
COMPLETE (完成)
  │
  │ vofa_get_command() 读取后
  ↓
IDLE (空闲)
```

## 实际示例分析

### 示例 1: "PR=2.32!"

| 步骤 | 接收字节 | ASCII | buffer内容      | index | 状态      | 说明           |
|------|----------|-------|-----------------|-------|-----------|----------------|
| 1    | 'P'      | 0x50  | [P]             | 1     | RECEIVING | 存入缓冲区     |
| 2    | 'R'      | 0x52  | [P,R]           | 2     | RECEIVING | 继续接收       |
| 3    | '='      | 0x3D  | [P,R,=]         | 3     | RECEIVING | 继续接收       |
| 4    | '2'      | 0x32  | [P,R,=,2]       | 4     | RECEIVING | 继续接收       |
| 5    | '.'      | 0x2E  | [P,R,=,2,.]     | 5     | RECEIVING | 继续接收       |
| 6    | '3'      | 0x33  | [P,R,=,2,.,3]   | 6     | RECEIVING | 继续接收       |
| 7    | '2'      | 0x32  | [P,R,=,2,.,3,2] | 7     | RECEIVING | 继续接收       |
| 8    | '!'      | 0x21  | [P,R,=,2,.,3,2] | 0     | COMPLETE  | 检测到帧尾,完成|

解析结果:
- cmd_buffer = "PR=2.32"
- param_name = "PR"
- param_value = 2.32

### 示例 2: "STOP!"

| 步骤 | 接收字节 | buffer内容 | 状态      |
|------|----------|------------|-----------|
| 1    | 'S'      | [S]        | RECEIVING |
| 2    | 'T'      | [S,T]      | RECEIVING |
| 3    | 'O'      | [S,T,O]    | RECEIVING |
| 4    | 'P'      | [S,T,O,P]  | RECEIVING |
| 5    | '!'      | [S,T,O,P]  | COMPLETE  |

解析结果:
- cmd_buffer = "STOP"
- 无 '=' 符号，判断为无参数命令

## 时序图

```
时间 →
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

VOFA+:     发送'P'  发送'R'  发送'='  发送'2'  发送'.'  发送'3'  发送'2'  发送'!'
           ──┬───   ──┬───   ──┬───   ──┬───   ──┬───   ──┬───   ──┬───   ──┬───
             │        │        │        │        │        │        │        │
串口硬件:    │接收    │接收    │接收    │接收    │接收    │接收    │接收    │接收
           ──┴───┬─ ──┴───┬─ ──┴───┬─ ──┴───┬─ ──┴───┬─ ──┴───┬─ ──┴───┬─ ──┴───┬─
                 │        │        │        │        │        │        │        │
中断服务:   触发中断│ 触发中断│ 触发中断│ 触发中断│ 触发中断│ 触发中断│ 触发中断│ 触发中断
           ─────┴── ─────┴── ─────┴── ─────┴── ─────┴── ─────┴── ─────┴── ─────┴──
                 │        │        │        │        │        │        │        │
vofa_parse:  存'P'   存'R'   存'='   存'2'   存'.'   存'3'   存'2'  完成!
           ─────┴── ─────┴── ─────┴── ─────┴── ─────┴── ─────┴── ─────┴── ─────┴──
                                                                                 │
主循环:                                                                      读取命令
           ─────────────────────────────────────────────────────────────────────┴──
                                                                                 │
处理命令:                                                                    执行操作
           ─────────────────────────────────────────────────────────────────────┴──
```

## 代码调用关系

```
main.c
  └── int_user()
       └── wireless_uart_init()
            └── uart_init(UART_3, ...)
                 └── uart_dma_init()
                      └── 使能接收中断

中断发生时:
  └── DMA_UART3_IRQHandler()  (isr.c)
       └── uart3_irq_handler()
            └── wireless_uart_callback()  (zf_device_wireless_uart.c)
                 ├── fifo_write_buffer()
                 └── vofa_parse_byte()  (vofa.c) ← 添加的调用
                      └── 解析字节,检测帧尾

主循环中:
  └── vofa_get_command()  (vofa.c)
       └── 返回完整命令
            └── handle_vofa_command()  (main.c)
                 └── 解析并执行命令
```

## 注意事项

1. **帧尾识别**: `!` (0x21) 是 FireWater 协议的关键标识
2. **字符串终止**: 解析完成后自动添加 `\0` 结束符
3. **缓冲区管理**: 自动重置 index,避免溢出
4. **状态同步**: 状态机保证数据完整性
5. **线程安全**: 中断中只写入,主循环中读取并清除标志
